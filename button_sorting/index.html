<!DOCTYPE html>
<html>
<head>

<script src="jQuery/jQuery-1.9.1.js">
</script>

<script>
var jq = jQuery;
var loadedTextLength;
//no conflict jQuery
jq.noConflict();
//jQuery stuff
jq(document).ready(function(){

	var url = "";
	if (window.location.search.length == 0) {
		url = jq("#dir").val();
	} 
	// Textbox
	else {
		url = decodeURIComponent(window.location.search.replace('?filePath=',''));
	}
	loadFile(url);
	
});

function clearTextArea() {
	jq("#snippets").text("");
}

function loadFile(docUrl){
	var url = docUrl;
	jq("#dir").val(url);
	window.history.pushState(null,"vi", "index.html?filePath=" + encodeURIComponent(url));
	jq.getJSON("http://localhost:9097/helloworld/json?filePath=" 
			+ encodeURIComponent(url))
		.done(function(result) {
			printTreeAsHtml(result);			
		})
		.fail(function() {
			alert('Failed. Is the server running?');
		});
}

function printTreeAsHtml(response) {
	var level = 0;
	jq("#snippets").val();
	var tree = response.tree;	
	tree.heading = "-root-"
	var text = "";

	var headings = {
		0 : {},
		1 : {},
		2 : {},
		3 : {},
		4 : {},
		5 : {},
		6 : {},
		7 : {},
	};
	for (var i = 0; i < tree.length; i++) {
		var snippet = tree[i];
		getHeadingLevelToHeadings(tree[i], 0, headings);
	}
	for (var i = 0; i < tree.length; i++) {
		var snippet = tree[i];
		text += printSnippet2(snippet, level + 1, tree, headings, tree);
	}
	jq("#snippets").append(headings + text);
}

function printSnippet2(snippet, level, rootTree, headings, parentSnippet) {
	var text = "";
	var text = "<div id="+snippet.id+"><table><tr><td>"; 
	text += snippet.heading + "(" + level+", "+snippet.id+", "+parentSnippet.heading+")<br>";
	if (level > 2 && level < 4) // Level 4 is also best left alone
	{
		text += "<textarea cols=80 rows=5>" + snippet.freetext + "</textarea><br></td><td>";
	
		var categories = [];
		if (level > 2) {
			categories = headings[level-2];
		}
		var sortedCategories = [];
		
		jq.each(categories, function(heading, id) {		
			//console.debug(heading);
			var p = {
				id : id,
				heading : heading,
			};
		    sortedCategories.push(p);
		});
		
		sortedCategories.sort(function(a,b){
 		    if(a.heading.toLowerCase() > b.heading.toLowerCase()){ return 1}
			if(a.heading.toLowerCase() < b.heading.toLowerCase()){ return -1}
			  return 0;
		});
		
		var i = 0;
		text += "<table><tr><td>";
		jq.each(sortedCategories, function(pos, obj) {
			i++;
			if (i %20 == 0) {
				text += "</td><td>";
			}
			text += "<input type=button value='"+ obj.heading +'\' onclick=\x22moveTo(\x27'+snippet.id+'\x27,\x27'+ obj.id +'\x27)\x22><br>\n';
		});
		text += "</td></tr></table>";
	
	}
	text += "<br></td></tr>";
	text += "</table>";
	jq.each(snippet.subsections, function(i, item) {
		text += printSnippet2(item, level + 1, rootTree,headings, snippet);
	});
	text += "</div>";
	return text;
}

function getHeadingLevelToHeadings(subtree, level, headingsAtLevels) {
	
	if (subtree.subsections != null) {	
		if (level > 0) {
			headingsAtLevels[level][subtree.heading] = subtree.id;
		}
		for (var i = 0; i < subtree.subsections.length; i++) {
			getHeadingLevelToHeadings(subtree.subsections[i],level+1,headingsAtLevels);
		}
	}
	
	return headingsAtLevels;
	
}

function dump(result)
{
	var text = "";
	jq.each(result['tree'], function(i, item) {
		text += printSnippet(item);
	});
	
	jq("#myTextArea").val(text);
	loadedTextLength = jq("#myTextArea").val().length;
}

// Deprecated
function printSnippet(jsonObject) {
	var ret = "";
	ret += jsonObject.heading;
	ret += jsonObject.freetext;
	
	console.debug(jsonObject.heading);
	console.debug(jsonObject.freetext);
	jq.each(jsonObject.subsections, function(i, item) {
		ret += printSnippet(item);
	});
	return ret;
}

function persistChanges() {
   var latestTextLength = jq("#myTextArea").val().length;
   
   if (latestTextLength == loadedTextLength) {
		console.debug('text has not changed length');
		return;
   }

   
   jq.ajax({          
            type:  'POST',
            url:   'http://localhost:9097/helloworld/persist',
			 data: { 
			 	filePath: encodeURIComponent(jq("#dir option:selected").val()),
			 	newFileContents : encodeURIComponent(jq("#myTextArea").val()),
			 }
         }).done(function() {
			console.debug("successfully written");
			loadedTextLength = latestTextLength;
         }).fail(function(){alert("fail")});
}

function moveTo(idToBeMoved, idOfTarget) {
	//alert(idToBeMoved + '::' + idOfTarget);
	var filePath = jq("#dir").val();

   jq.ajax({          
		type:  'POST',
		url:   'http://localhost:9097/helloworld/move?filePath=' +filePath +"&id=" +idToBeMoved+ "&destId=" + idOfTarget,
		 data: { 
			//filePath: encodeURIComponent(jq("#dir option:selected").val()),
			//newFileContents : encodeURIComponent(jq("#myTextArea").val()),
		 }
	 }).done(function() {
		 jq("#"+idToBeMoved).remove();
		console.debug("successfully written: " + idToBeMoved);
	 }).fail(function(){alert("fail")});
}
</script>

</head>
<body>
<input type="button" value="== Rohidekar brand ==" onclick="moveTo('2762d89e11131511c238be15f2a63c88','d41d8cd98f00b204e9800998ecf8427e'" />

	<!-- TODO: remove all references to myTextArea -->
	<textarea id="myTextArea" rows=2 cols=150 onkeyup="persistChanges()"></textarea>

	<select id="dir" name="sometext" onchange="clearTextArea();loadFile(jq('#dir option:selected').val())">		
		<option>/Users/sarnobat/Desktop/git-repo/mwk/atletico_documentary.mwk</option>
		<option>/Users/sarnobat/Desktop/git-repo/mwk/humor-cheat-sheet.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/programming-tips.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/productivity-cheat-sheet.mwk</option>

		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/technology.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/technology-linux.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/new.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/academic-class-notes.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/academic.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/business.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/career.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/communication.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/docs.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/entertainment.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/finance.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/geography.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/girls.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/git.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/health.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/humor-cheat-sheet.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/learning.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/life-story.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/misc.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/new.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/new_google.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/people.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/poster.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/productivity-cheat-sheet.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/programming-tips.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/self.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/session.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/soccer.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/stepz.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/technology/eclipse.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/technology-apps.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/technology-linux.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/technology.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/winning-cheat-sheet.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/youtube_finished.mwk</option>
		<option>/Users/sarnobat/Desktop/mac-sync/cheat-sheets-plain-text/yurled.mwk</option>
	</select>
<!--
	<button onclick="alert('unimplemented')">Sort this file</button>
	<button onclick="regenerateToc()">Regenerate Contents</button>
	<button onclick="alert('unimplemented')">Save Changes, Regenerate Contents</button>
-->
	
	<div id="snippets">

	
		<div id="output">
		</div>
	
	
		<div></div>
	
	</DIV>

</body>
</html>
